using System.Collections;
using System.Collections.Generic;
using UnityEngine;
using Photon.Pun;

public class JM_GameManager : MonoBehaviourPun
{
    // 싱글톤
    public static JM_GameManager instance;

    // 현재 waitRoom 인지 gameRoom 인지 판단
    public bool isGameRoom;

    // 플레이어들을 저장할 리스트
    public List<PhotonView> playerList = new List<PhotonView>();

    // 초기 스폰위치 리스트
    public List<Transform> spawnPosList = new List<Transform>();

    private void Awake()
    {
        instance = this;
    }

    void Start()
    {
        PhotonNetwork.SerializationRate = 60;

        PhotonNetwork.SendRate = 60;

        int randomNum = Random.Range(0, 3);

        // 방 인원 수 text 업데이트
        SH_RoomUI.instance.PlayerNumUpdate();

        GameObject crew = PhotonNetwork.Instantiate("Crew", spawnPosList[randomNum].position, Quaternion.identity);
    }

    void Update()
    {
        // 방장이 Start버튼 누른 경우 playerList photonView의 gameObject 비활성화
        if (SH_RoomUI.instance.isStart)
        {
            // imposter 수 매개변수로 넣어서 imposter 지정 로직 시작
            SetGameScene((int)PhotonNetwork.CurrentRoom.CustomProperties["imposter"]);
            for (int i=0; i < playerList.Count; i++)
            {
                playerList[i].gameObject.SetActive(false);
            }
        }


        // 방장이 Start버튼 누르고 gameIntro가 다 끝난 경우 
        //if (SH_RoomUI.instance.isStart && )
        //{
        //    isGameRoom = true
        //}
    }

    // 플레이어 생성될 때 호출됨 (PlayerMove.cs의 Start)
    public void AddPlayer(PhotonView pv)
    {
        // 플레이어 리스트에 플레이어 포톤 뷰 저장
        playerList.Add(pv);
    }
    // 임포스터 idx 선정
    public void SetGameScene(int imposterAmt)
    {
        //isGameRoom = true;
        if (PhotonNetwork.IsMasterClient)
        {
            // int 로 이루어진 리스트를 만들고
            List<int> imposterIndexList = new List<int>();

            // 임포스터 수만큼의 for 문을 돌려서
            for (int i = 0; i < imposterAmt; i++)
            {
                // 플레이어 최대 숫자와 0 사이에서 랜덤 숫자를 생성
                int randomNum = 0;
                    //Random.Range(0, playerList.Count);
                print("임포스터 인덱스 : " + randomNum);
                // 임포스터 리스트에 랜덤숫자가 없다면
                if (!imposterIndexList.Contains(randomNum))
                {
                    // 리스트에 랜덤숫자 추가
                    imposterIndexList.Add(randomNum);
                }
                // 그렇지 않다면
                else
                {
                    // 다시 랜덤숫자 구함
                    randomNum = Random.Range(0, playerList.Count);
                }
            }
            ChooseImposter(imposterIndexList);
        }
    }
    // imposter 인덱스를 담은 리스트를 받아 imposter 지정
    void ChooseImposter(List<int> imposterIndexList)
    {
       for (int i = 0; i < playerList.Count; i++)
        {
            // 임포스터의 인덱스가 맞다면
            for (int j = 0; j < imposterIndexList.Count; j++)
            {
                if (i == imposterIndexList[j])
                {
                    // RPC 함수로 해당 인덱스 플레이어는 임포스터 할당
                    playerList[i].RPC("RPC_SetImposter", RpcTarget.All);
                    print("얘는 임포스터임" + i);
                }
                else
                {
                    playerList[i].RPC("RPC_SetCrew", RpcTarget.All);
                    print("얘는 크루임" + i);
                }
            }
        }       
    }
}
